CC = @CC@

CFLAGS = -Wall -c -g
LDFLAGS =
LIBS = @LIBS@

BLUETOOTH_DIR  = bluetooth
USB_DIR        = usb
CONTROLLER_DIR = controller
SPI_DIR        = spi
TOOLS_DIR      = tools
TOOLS          = $(TOOLS_DIR)/ds4_sync.c $(TOOLS_DIR)/ds4_conn.c
TOOL_OBJS      = $(TOOLS:.c=.o)
TOOL_EXES      = $(basename $(TOOLS))

all: bluetooth usb tools spi

spi: $(SPI_DIR)/spi_test

$(SPI_DIR)/spi_test: $(SPI_DIR)/spidev_test.c
	$(CC) -I/opt/poky-edison/1.6/sysroots/core2-32-poky-linux/usr/include -Wall -o $@ $^

bluetooth: $(BLUETOOTH_DIR)/ds4_bt.o

$(BLUETOOTH_DIR)/ds4_bt.o: $(BLUETOOTH_DIR)/ds4_bt.c
	$(CC) $(CFLAGS) -o $@ $^

usb: $(USB_DIR)/ds4_usb.o

$(USB_DIR)/ds4_usb.o: $(USB_DIR)/ds4_usb.c
	$(CC) $(CFLAGS) $(shell pkg-config libusb-1.0 --cflags) -o $@ $^

tools: $(TOOL_EXES)

$(TOOL_EXES): %: %.o $(USB_DIR)/ds4_usb.o $(BLUETOOTH_DIR)/ds4_bt.o
	$(CC) $(LDFLAGS) -o $@ $^ $(LIBS)

$(TOOL_OBJS): %.o: %.c
	$(CC) $(CFLAGS) $(shell pkg-config libusb-1.0 --cflags) -I$(CONTROLLER_DIR)/ -I$(BLUETOOTH_DIR)/ -I$(USB_DIR)/ -o $@ $<

clean:
	rm -f $(TOOL_EXES)
	rm -f $(TOOL_OBJS)
	rm -f $(BLUETOOTH_DIR)/*.o
	rm -f $(USB_DIR)/*.o
